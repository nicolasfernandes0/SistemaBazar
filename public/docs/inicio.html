<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!--teste-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bazar Beneficente</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="shortcut icon" href="imagens/logo.png" type="logo/png">
    <link rel="stylesheet" href="/public/CSS/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <!--√≠cone de sair-->
    
</head>
<body><!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom"><!-- faz o menu se expandir em telas grandes e colapsar (virar √≠cone) em telas pequenas -->
        <img src="/public/docs/imagens/logo.png" alt="logo" style="margin:10px" width="75" margin-left="10px">
        <div class="container-fluid"> <!--cobre toda largura da tela-->
            <a class="navbar-brand" href="#" style="color: #333;">Bazar S√£o Jer√¥nimo</a><!--marca o t√≠tulo da navbar-->
          <br><br>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span><!--cria o bot√£o de menu-->
          </button>
      
          <div class="collapse navbar-collapse" id="navbarNav"><!--indica que o bot√£o ser√° aberto/fechado na pr√≥xima div-->
            <ul class="navbar-nav me-auto"><!--lista de navega√ß√£o do css-->
                <li class="nav-item">
                    <a class="nav-link active" href="inicio.html">In√≠cio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="relatorio.html">Relat√≥rios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="anotacoes.html">Anota√ß√µes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="promocoes.html">Promo√ß√µes</a>
                </li>
            </ul>
            <button class="btn btn-sair ms-2" onclick="sair()"><!--deixa o bot√£o "sair" para direita-->
              <i class="fas fa-sign-out-alt"></i> Sair
            </button>
          </div>       
      </nav>      
    <!-- Configura√ß√µes da caixa de venda -->
    <br>
    <br>
    <div class="container-alt">
        <center><h1>Registro de Vendas</h1></center>
        <form id="itemForm">
                <label for="itemValor">Valor:</label>
                    <div class="input-group mb-3">
                    <span class="input-group-text">R$</span> <!-- coloca o R$ dentro da caixa de input do valor-->
                    <input type="text" class="form-control" id="itemValor" placeholder="üí∞"> <!-- a classe form-control (do bootstrap) padroniza o tamanho das caixas -->
                    </div>
                <label> Forma de pagamento: </label>
                <select class="form-control">
                    <option placeholder> Selecione uma op√ß√£o </option>
                    <option value="pix"> Pix </option>
                    <option value="cr√©dito"> Cart√£o de cr√©dito </option>
                    <option value="d√©bito"> Cart√£o de d√©bito </option>
                    <option value="dinheiro"> Dinheiro </option>
                </select>
                <br>
                <label> Data: </label>
                    <input class="form-control" type="date" id="itemData">
                <br> 
                <label> Nome do comprador: </label>
                    <input class="form-control" type="text" id="itemComprador" placeholder="üë§(Opcional)">
                <br> 
                <label> N√∫mero de telefone: </label>
                    <input class="form-control" type="text" id="itemTelefone" placeholder="(Opcional)">
                <br> 
                <label> Email: </label>
                    <input class="form-control" type="text" id="itemEmail" placeholder="(Opcional)">
                <br><br>
                    <center> <button type="submit" class="btn-adicionar" > Adicionar</button> </center>
        </form>
    </div>
    <div id="statusMessage" class="status-message"></div>
    <div class="error-details"></div>
    <script>  
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBg_LBg0LoH7ADKPHN571ARxEjhgUN2TmE",
            authDomain: "bazar-46805.firebaseapp.com",
            projectId: "bazar-46805",
            storageBucket: "bazar-46805.firebasestorage.app",
            messagingSenderId: "296506105856",
            appId: "1:296506105856:web:bb261ba6c4a2406d52b8e5"
        };

        // Inicialize o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Elementos da UI
        const statusMessage = document.getElementById('statusMessage');
        const form = document.getElementById('itemForm');

        // Fun√ß√£o para mostrar mensagens de status
        function showStatus(message, type, details = '') {
            statusMessage.innerHTML = message + (details ? `<div class="error-details">${details}</div>` : '');
            statusMessage.className = 'status-message ' + type;
            
            // Rolagem autom√°tica para a mensagem
            statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Fun√ß√£o para traduzir erros comuns do Firebase
        function translateFirebaseError(error) {
            const errorMap = {
                'permission-denied': 'Permiss√£o negada: Voc√™ n√£o tem acesso ao banco de dados',
                'unauthenticated': 'N√£o autenticado: Fa√ßa login novamente',
                'invalid-argument': 'Dados inv√°lidos foram enviados',
                'not-found': 'Cole√ß√£o n√£o encontrada',
                'already-exists': 'Documento j√° existe',
                'resource-exhausted': 'Limite de cota excedido',
                'failed-precondition': 'Opera√ß√£o n√£o permitida no estado atual',
                'aborted': 'Opera√ß√£o abortada',
                'unavailable': 'Servi√ßo indispon√≠vel no momento',
                'internal': 'Erro interno do servidor'
            };
            
            return errorMap[error.code] || error.message;
        }

        // Adiciona evento de submit ao formul√°rio
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Mostra mensagem de conex√£o
            showStatus("üîå Conectando ao banco de dados...", "connecting");
            
            // Desabilita o bot√£o para evitar m√∫ltiplos cliques
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            try {
                // Captura os valores dos campos
                const valor = parseFloat(document.getElementById('itemValor').value);
                const formaPagamento = document.querySelector('select.form-control').value;
                const data = document.getElementById('itemData').value;
                const comprador = document.getElementById('itemComprador').value || 'An√¥nimo';
                const telefone = document.getElementById('itemTelefone').value || '';
                const email = document.getElementById('itemEmail').value || '';

                // Valida√ß√£o avan√ßada
                if (isNaN(valor)) {
                    throw new Error('O valor deve ser um n√∫mero');
                }
                
                if (valor <= 0) {
                    throw new Error('O valor deve ser maior que zero');
                }
                
                if (!data) {
                    throw new Error('A data √© obrigat√≥ria');
                }

                // Mostra que est√° enviando dados
                showStatus("üì§ Enviando dados para o servidor...", "connecting");

                // Salva no Firestore
                const docRef = await db.collection('vendas').add({
                    valor: valor,
                    formaPagamento: formaPagamento,
                    data: data,
                    comprador: comprador,
                    telefone: telefone,
                    email: email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Mensagem de sucesso com ID do documento
                showStatus("Venda registrada com sucesso!", "success");
                
                // Limpa o formul√°rio
                form.reset();
                document.getElementById('itemData').value = getCurrentDate();
                
                // Oculta a mensagem ap√≥s 5 segundos
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error("Erro detalhado:", error);
                
                // Mensagem de erro detalhada
                let errorMessage = "‚ùå Erro ao registrar venda";
                let errorDetails = "";
                
                if (error.code) {
                    // Erro do Firebase
                    errorMessage = translateFirebaseError(error);
                    errorDetails = `C√≥digo: ${error.code}\nMensagem: ${error.message}`;
                    
                    // Se for erro de permiss√£o, sugere a√ß√£o
                    if (error.code === 'permission-denied') {
                        errorDetails += "\n\nVerifique se voc√™ est√° logado e tem permiss√µes suficientes.";
                    }
                } else {
                    // Erro de valida√ß√£o ou outro erro JavaScript
                    errorDetails = error.message;
                }
                
                showStatus(errorMessage, "error", errorDetails);
                
                // Se for erro de conex√£o, sugere tentar novamente
                if (error.code === 'unavailable' || error.message.includes('offline')) {
                    showStatus(`${errorMessage} - Tentando reconectar...`, "warning", errorDetails);
                    
                    // Tenta reconectar ap√≥s 5 segundos
                    setTimeout(() => {
                        showStatus("Tentando reconectar ao banco de dados...", "connecting");
                    }, 5000);
                }
                
            } finally {
                submitButton.disabled = false;
            }
        });

        // Fun√ß√µes auxiliares
        function getCurrentDate() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        document.getElementById('itemData').value = getCurrentDate();

        function sair() {
            if(confirm('Tem certeza que deseja sair do sistema?')) {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            }
        }

        // Monitora o estado da conex√£o
        firebase.firestore().enableNetwork()
            .then(() => console.log("Online"))
            .catch(err => console.error("Erro de conex√£o:", err));

        // Verifica√ß√£o de autentica√ß√£o
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                // Verifica permiss√µes ao carregar a p√°gina
                db.collection('vendas').limit(1).get()
                    .then(() => console.log("Permiss√µes OK"))
                    .catch(err => {
                        showStatus("Verifique suas permiss√µes de acesso", "warning", 
                                translateFirebaseError(err));
                    });
            }
        });
    </script>
    <!-- Bootstrap JavaScript e depend√™ncia Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
